#操作系统Lab2实验报告

2013011303 计32 程凯

##练习一：实现first-fit连续物理内存分配算法

###实现过程
1、default_init_memap
>    初始化从base开始的n页。
     第一页特殊处理，并最后并入free_list

2、default_aloc_pages
> 第一个步骤寻找大小合适的空闲块，即第一个大小大于等于n的空闲块。
第二个步骤对空闲块分为两种情况进行处理，一种情况空闲块大小恰好等于所要分配的内存大小就将该块所在的page，都置为使用，且从空闲列表中去除。另一种情况空闲块大小大于要分配的内存大小，即还有剩余，就需要在以上操作的基础上设置剩余块的第一个page的propety值并维护free_list。

3、default_free_pages
> 从base开始释放n页。
先遍历n页释放空间，再寻找free_list中应插入的位置。
插入free_list，并在可以的时候合并前驱后继。

<br>
###是否还有改进空间
> 有。可以适当建立索引，用于分配和释放时加速定位。使用平衡树维护free_list。
<br>

##练习二：实现寻找虚拟地址对应的页表项

###实现过程
```
首先根据虚地址用PDX得到页目录项的index，然后在pgdir中得到这个页目录项的内容。如果这个页目录项不存在的话。就调用alloc_page为其分配一项，新建page之后需要为这一page进行初始化，然后让这个页目录项指向这个新初始化的位置。
下一步根据得到的目录项，获取其中页表项的物理地址，然后用这个物理地址调用KADDR去获取了页表项的起始的内核虚地址，然后根据la中给出的页表项的index得到了对应的页表项的内核虚地址。
```
###PDE和PTE中每个组成部分的含义和对ucore而言的潜在用途
PDE和PTE的前20位都是地址，后12位的定义在`mmu.h`中：

    #define PTE_P           0x001                   // Present
    #define PTE_W           0x002                   // Writeable
    #define PTE_U           0x004                   // User
    #define PTE_PWT         0x008                   // Write-Through
    #define PTE_PCD         0x010                   // Cache-Disable
    #define PTE_A           0x020                   // Accessed
    #define PTE_D           0x040                   // Dirty
    #define PTE_PS          0x080                   // Page Size
    #define PTE_MBZ         0x180                   // Bits must be zero
    #define PTE_AVAIL       0xE00                   // Available for software use
                                                  

PDE中有对应的二级页表基地址，以及三个权限位：是否有效、可写、可被用户访问；PTE中有对应页的物理基地址，以及两个权限位：是否有效、可写。 这些权限位用于判断页面是否存在，用来管理内存以及保护数据。

###如果ucore执行过程中访问内存，出现了页访问异常，硬件要做哪些事情？
> 执行中断，权限交由操作系统，在内存与硬盘间交换数据。

<br>
##练习三：释放某虚地址所在的页并取消对应二级页表项的映射
###实现过程
> 首先检查pte是否有效，如果有效，查询到其对应的页。将它对应的页关联数减去一。如果没有实际空间关联，则释放该页。最后将该pte设为空，并使对应TLB失效。


###数据结构Page的全局变量（其实是一个数组）的每一项与页表中的页目录项和页表项有无对应关系？如果有，其对应关系是啥？
>有关系。数组的第n项左移12位便是对应页目录项和页表项的高20位。

<br>
###如果希望虚拟地址与物理地址相等，则需要如何修改lab2，完成此事？
> 在alloc_page中传入虚拟地址，使其分配或替换相等物理地址的页。

<br>
##与参考答案的区别
> 练习一中有一些区别，例如在分配空间时，先找到了一个可用页，再对这个页进行操作；而参考答案是把这两步揉在了一起。而练习二和练习三中除了代码次序有一些区别其他差别不大。

<br>
##列出你认为本实验中重要的知识点，以及与对应的OS原理中的知识点，并简要说明你对二者的含义，关系，差异等方面的理解
> 连续内存分配算法，在本次实验中只要求实现了first-fit的连续内存分配算法，应当同时了解其他在原理课中讲述的分配算法。操作系统页机制的实现,二级页表的结构和对应关系，以及页表项、页目录项的构成，如何完成从虚拟地址到物理地址的转换。

<br>
##列出你认为OS原理中很重要，但在实验中没有对应上的知识点
> 快表和反置页表